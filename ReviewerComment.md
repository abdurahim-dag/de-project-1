    Еще есть способ обойтись без подзапроса и при этом узнать новый функционал - "форточки в оконных функциях"
    SELECT 
        DISTINCT o.order_id,
        o.order_ts,
        o.user_id,
        o.bonus_payment,
        o.payment,
        o."cost",
        o.bonus_grant,
        LAST_VALUE(p.status_id) OVER (PARTITION BY p.order_id ORDER BY dttm ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS status
    FROM 
        production.orders AS o
    JOIN
        production.orderstatuslog AS p
            USING(order_id)
**Спасибо тебе**, очень помогло разобраться в понимании оконных функциях! Есть вопрос: в тексте указано *ROWS BETWEEN CURRENT ROW*, почему не *BETWEEN UNBOUNDED PRECEDING*? Или в данном случаи и *CURRENT ROW* и *UNBOUNDED PRECEDING* указывают на одно и тоже?

**tmp_rfm_*.sql**

    1. Ранги должны распределяться по пользователям равномерно, для 1000 пользователей должно получится 200 с 1-м рангом, 200 с 2-м рангом и так далее. Надо просто проранжировать столбец с количеством заказов
    2. Не попадают клиенты, у которых не было успешных заказов.
    В ТЗ сказано:
    Распределите клиентов по шкале от одного до пяти, где значение 1 получат те, кто либо вообще 
    не делал заказов, либо делал их очень давно, а 5 — те, кто заказывал относительно недавно.
    Это означает, что клиенты без успешных заказов должны попасть в витрину с минимальным рангом

### Есть не понимание, по этому замечению. 
Ранги распределяю по уникальным значениям фактора. В таком случаи ранги распределятся не равномерно (возможны одинаковые значение Frequency, Monetary Value). Т.е. каждый фактор ранжируется по уникальным значениям: 1 - кол-во заказов 0..4; 2 - кол-во заказов 5..8; и т.д. Что выбрано мной.

Еще один способ ранжировать не значения, а пользователей и сортировкой по соответствующему  полю. Тогда распределение будет равномерным для количества пользователей кратным 5. Если ранжировать так, то возможна ситуация когда пользователи с одинаковым значением фактора попадут в разные ранги. 

По условию выходит два момента: "Ранги должны распределяться по пользователям равномерно" и "Распределите клиентов по шкале от одного до пяти, где **значение 1** получат те, кто либо вообще не делал заказов, либо делал их очень давно, а 5 — те, кто заказывал относительно недавно"

По этому замечанию исправлено попадание клиентов без заказов.